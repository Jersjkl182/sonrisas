<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>{% block title %}Panel Acudiente - Teaching Notes{% endblock %}</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Montserrat+Alternates:wght@400;500;600&display=swap" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/acudiente/acudiente_modern.css') }}">
    {% block extra_css %}{% endblock %}
</head>
<body>
<header class="header">
    <div class="container">
        <div class="user-profile-dropdown">
            <div class="user-profile-link" id="userProfileToggle">
                <span>Hola, {{ session.get('nombre', 'Acudiente') }}</span>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="user-dropdown-menu" id="userDropdownMenu">
                <a href="{{ url_for('main_bp.perfil_acudiente') }}" class="dropdown-item">
                    <i class="fas fa-user-circle"></i>
                    <span>Mi Perfil</span>
                </a>
                <a href="{{ url_for('auth_bp.cerrar_sesion') }}" class="dropdown-item" onclick="return confirm('¿Cerrar sesión?');">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Cerrar Sesión</span>
                </a>
            </div>
        </div>
    </div>
</header>

<main class="main-content">
    <!-- Mensajes Flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <ul class="flashes">
                {% for category, message in messages %}
                    <li class="{{ category }}">
                        {% if category == 'success' %}
                            <i class="fas fa-check-circle"></i>
                        {% elif category == 'danger' %}
                            <i class="fas fa-exclamation-triangle"></i>
                        {% elif category == 'warning' %}
                            <i class="fas fa-exclamation-circle"></i>
                        {% elif category == 'info' %}
                            <i class="fas fa-info-circle"></i>
                        {% endif %}
                        {{ message }}
                    </li>
                {% endfor %}
            </ul>
        {% endif %}
    {% endwith %}
    {% block content %}{% endblock %}
</main>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Toggle del dropdown del usuario - Versión mejorada
    const userProfileToggle = document.getElementById('userProfileToggle');
    const userDropdownMenu = document.getElementById('userDropdownMenu');
    
    if (userProfileToggle && userDropdownMenu) {
        // Variable para controlar el estado del dropdown
        let dropdownOpen = false;
        let clickInProgress = false;
        
        // Función para abrir dropdown
        function openDropdown() {
            dropdownOpen = true;
            userDropdownMenu.classList.add('show');
            const icon = userProfileToggle.querySelector('.fa-chevron-down');
            if (icon) {
                icon.style.transform = 'rotate(180deg)';
            }
        }
        
        // Función para cerrar dropdown
        function closeDropdown() {
            dropdownOpen = false;
            userDropdownMenu.classList.remove('show');
            const icon = userProfileToggle.querySelector('.fa-chevron-down');
            if (icon) {
                icon.style.transform = 'rotate(0deg)';
            }
        }
        
        // Click en el toggle
        userProfileToggle.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            clickInProgress = true;
            
            if (dropdownOpen) {
                closeDropdown();
            } else {
                openDropdown();
            }
            
            // Reset flag después de un breve delay
            setTimeout(() => {
                clickInProgress = false;
            }, 50);
        });
        
        // Evitar que clicks dentro del dropdown lo cierren
        userDropdownMenu.addEventListener('click', function(e) {
            e.stopPropagation();
        });
        
        // Cerrar dropdown al hacer click fuera (con delay para evitar conflictos)
        document.addEventListener('click', function(e) {
            // Solo procesar si no hay un click en progreso
            if (!clickInProgress && dropdownOpen) {
                // Verificar que el click no sea en el toggle o el menu
                if (!userProfileToggle.contains(e.target) && !userDropdownMenu.contains(e.target)) {
                    closeDropdown();
                }
            }
        });
        
        // Cerrar dropdown al presionar Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && dropdownOpen) {
                closeDropdown();
            }
        });
    }
});
</script>
</body>
</html>
            const dropdownContent = childrenDropdown.querySelector('.dropdown-content');
            if (dropdownContent) {
                dropdownContent.innerHTML = `
                    <div class="dropdown-loading" style="padding: var(--spacing-xl); text-align: center;">
                        <div class="loading-spinner">
                            <div class="spinner"></div>
                        </div>
                        <span style="color: #7f8c8d; font-size: 13px; margin-top: var(--spacing-sm); display: block;">Cargando estudiantes...</span>
                    </div>
                `;
            }
            
            console.log('Intentando cargar desde:', '/acudiente/api/hijos-temp');
            
            // Configurar timeout para la petición
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 segundos timeout
            
            const response = await fetch('/acudiente/api/hijos-temp', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                signal: controller.signal
            });
            
            clearTimeout(timeoutId);
            console.log('Response status:', response.status);
            console.log('Response headers:', response.headers);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.log('Error response:', errorText);
                throw new Error(`Error del servidor: ${response.status} - ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('Datos recibidos:', data);
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            childrenData = data.hijos || [];
            console.log('Estudiantes cargados:', childrenData.length);
            
            // Si no hay datos del servidor, usar datos de prueba
            if (childrenData.length === 0) {
                console.log('No hay datos del servidor, usando datos de prueba');
                childrenData = [
                    {
                        id: 1,
                        nombre: 'Angelo Curiel',
                        grado: 'Preescolar'
                    },
                    {
                        id: 2,
                        nombre: 'María García',
                        grado: 'Primero'
                    },
                    {
                        id: 3,
                        nombre: 'Juan Pérez',
                        grado: 'Segundo'
                    }
                ];
            }
            
            renderChildrenDropdown();
            
        } catch (error) {
            console.error('Error loading children:', error);
            
            // Si es un error de conexión, usar datos de prueba como fallback
            if (error.name === 'AbortError' || error.message.includes('fetch')) {
                console.log('Error de conexión detectado, usando datos de prueba como fallback');
                childrenData = [
                    {
                        id: 1,
                        nombre: 'Angelo Curiel',
                        grado: 'Preescolar'
                    },
                    {
                        id: 2,
                        nombre: 'María García',
                        grado: 'Primero'
                    },
                    {
                        id: 3,
                        nombre: 'Juan Pérez',
                        grado: 'Segundo'
                    }
                ];
                renderChildrenDropdown();
                return;
            }
            
            // Mostrar error en el contenido del dropdown solo si no es un error de conexión
            const dropdownContent = childrenDropdown.querySelector('.dropdown-content');
            if (dropdownContent) {
                dropdownContent.innerHTML = `
                    <div class="dropdown-error" style="padding: var(--spacing-xl); text-align: center; color: #e74c3c;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: var(--spacing-sm);"></i>
                        <div style="font-size: 14px; margin-bottom: var(--spacing-sm);">Error de conexión</div>
                        <div style="font-size: 12px; color: #7f8c8d; margin-bottom: var(--spacing-md);">
                            ${error.message || 'No se pudo conectar con el servidor'}
                        </div>
                        <button onclick="loadChildren()" style="
                            margin-top: var(--spacing-sm);
                            padding: var(--spacing-sm) var(--spacing-md);
                            background: var(--secondary-yellow);
                            color: white;
                            border: none;
                            border-radius: var(--radius-md);
                            cursor: pointer;
                            font-size: 12px;
                            transition: var(--transition-fast);
                        " onmouseover="this.style.background='var(--dark-yellow)'" 
                           onmouseout="this.style.background='var(--secondary-yellow)'">
                            <i class="fas fa-redo" style="margin-right: 4px;"></i>
                            Reintentar
                        </button>
                        <button onclick="useFallbackData()" style="
                            margin-top: var(--spacing-sm);
                            margin-left: var(--spacing-sm);
                            padding: var(--spacing-sm) var(--spacing-md);
                            background: var(--info-color);
                            color: white;
                            border: none;
                            border-radius: var(--radius-md);
                            cursor: pointer;
                            font-size: 12px;
                            transition: var(--transition-fast);
                        " onmouseover="this.style.background='#2980b9'" 
                           onmouseout="this.style.background='var(--info-color)'">
                            <i class="fas fa-database" style="margin-right: 4px;"></i>
                            Usar datos de prueba
                        </button>
                    </div>
                `;
            }
        }
    }
    
    // Función para usar datos de prueba como fallback
    window.useFallbackData = function() {
        console.log('Usando datos de prueba por solicitud del usuario');
        childrenData = [
            {
                id: 1,
                nombre: 'Angelo Curiel',
                grado: 'Preescolar'
            },
            {
                id: 2,
                nombre: 'María García',
                grado: 'Primero'
            },
            {
                id: 3,
                nombre: 'Juan Pérez',
                grado: 'Segundo'
            }
        ];
        renderChildrenDropdown();
    };
    
    function renderChildrenDropdown() {
        const dropdownContent = childrenDropdown.querySelector('.dropdown-content');
        
        if (childrenData.length === 0) {
            dropdownContent.innerHTML = `
                <div class="dropdown-empty" style="padding: var(--spacing-xl); text-align: center; color: #7f8c8d;">
                    <i class="fas fa-info-circle" style="font-size: 24px; margin-bottom: var(--spacing-sm); color: var(--secondary-yellow);"></i>
                    <div>Sin estudiantes registrados</div>
                </div>
            `;
            return;
        }
        
        let html = '';
        childrenData.forEach((child, index) => {
            html += `
                <div class="student-item" data-child-id="${child.id}" style="
                    display: flex;
                    align-items: center;
                    gap: var(--spacing-md);
                    padding: var(--spacing-md) var(--spacing-lg);
                    cursor: pointer;
                    transition: var(--transition-fast);
                    border-bottom: 1px solid var(--glass-border);
                    animation: fadeInUp 0.3s ease-out ${index * 0.1}s both;
                ">
                    <div class="student-avatar" style="
                        width: 36px;
                        height: 36px;
                        background: var(--gradient-primary);
                        border-radius: var(--radius-full);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-size: 14px;
                        flex-shrink: 0;
                        box-shadow: var(--shadow-light);
                    ">
                        <i class="fas fa-user-graduate"></i>
                    </div>
                    <div class="student-info" style="flex: 1; min-width: 0;">
                        <div class="student-name" style="
                            font-weight: var(--font-weight-semibold);
                            color: #2c3e50;
                            font-size: 14px;
                            margin-bottom: 2px;
                            white-space: nowrap;
                            overflow: hidden;
                            text-overflow: ellipsis;
                        ">${child.nombre}</div>
                        <div class="student-grade" style="
                            font-size: 12px;
                            color: var(--secondary-yellow);
                            font-weight: var(--font-weight-medium);
                        ">${child.grado}</div>
                    </div>
                    <div class="select-indicator" style="
                        width: 20px;
                        height: 20px;
                        border: 2px solid var(--glass-border);
                        border-radius: var(--radius-full);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        transition: var(--transition-fast);
                    ">
                        <i class="fas fa-check" style="font-size: 10px; color: var(--success-color); opacity: 0;"></i>
                    </div>
                </div>
            `;
        });
        
        dropdownContent.innerHTML = html;
        
        // Agregar event listeners y efectos hover
        const studentItems = dropdownContent.querySelectorAll('.student-item');
        studentItems.forEach(item => {
            // Hover effects
            item.addEventListener('mouseenter', function() {
                this.style.background = 'rgba(246, 218, 99, 0.1)';
                this.style.transform = 'translateX(8px)';
                const indicator = this.querySelector('.select-indicator');
                indicator.style.borderColor = 'var(--secondary-yellow)';
                indicator.style.background = 'rgba(246, 218, 99, 0.1)';
            });
            
            item.addEventListener('mouseleave', function() {
                this.style.background = 'transparent';
                this.style.transform = 'translateX(0)';
                const indicator = this.querySelector('.select-indicator');
                indicator.style.borderColor = 'var(--glass-border)';
                indicator.style.background = 'transparent';
            });
            
            // Click event
            item.addEventListener('click', function() {
                const childId = parseInt(this.dataset.childId);
                
                // Animación de selección
                const checkIcon = this.querySelector('.fas.fa-check');
                const indicator = this.querySelector('.select-indicator');
                
                indicator.style.background = 'var(--success-color)';
                indicator.style.borderColor = 'var(--success-color)';
                checkIcon.style.opacity = '1';
                checkIcon.style.color = 'white';
                
                setTimeout(() => {
                    selectChild(childId);
                }, 300);
            });
        });
    }
    
    function selectChild(childId) {
        const child = childrenData.find(c => c.id === childId);
        if (!child) return;
        
        selectedChildId = childId;
        
        // Actualizar texto del botón selector con animación
        const selectorText = childrenToggle.querySelector('.selector-text');
        const selectorSubtitle = childrenToggle.querySelector('.selector-subtitle');
        
        if (selectorText && selectorSubtitle) {
            // Animación de cambio de texto
            selectorText.style.opacity = '0';
            selectorSubtitle.style.opacity = '0';
            
            setTimeout(() => {
                selectorText.textContent = child.nombre;
                selectorSubtitle.textContent = child.grado;
                selectorText.style.opacity = '1';
                selectorSubtitle.style.opacity = '1';
            }, 150);
        }
        
        // Actualizar información del hijo seleccionado
        document.getElementById('selectedChildName').textContent = child.nombre;
        document.getElementById('selectedChildGrade').textContent = child.grado;
        
        // Mostrar información del hijo seleccionado con animación
        selectedChildInfo.style.display = 'block';
        selectedChildInfo.style.animation = 'fadeInUp 0.5s ease-out';
        
        // Cerrar dropdown con animación
        childrenDropdown.style.transform = 'translateY(-10px) scale(0.95)';
        childrenDropdown.style.opacity = '0';
        
        setTimeout(() => {
            childrenDropdown.style.display = 'none';
            childrenDropdown.style.transform = '';
            childrenDropdown.style.opacity = '';
        }, 300);
        
        // Resetear botón
        childrenToggle.classList.remove('active');
        const toggleIcon = childrenToggle.querySelector('.toggle-icon');
        if (toggleIcon) {
            toggleIcon.style.transform = 'rotate(0deg)';
        }
        
        // Disparar evento personalizado
        const event = new CustomEvent('childSelected', {
            detail: { childId: childId, child: child }
        });
        document.dispatchEvent(event);
        
        // Redirigir al dashboard si estamos en la página principal
        if (window.location.pathname === '/acudiente' || window.location.pathname === '/acudiente/') {
            setTimeout(() => {
                window.location.href = '/acudiente/dashboard';
            }, 800);
        }
    }
    
    function showError(message) {
        childrenDropdown.innerHTML = `
            <div class="error-children">
                <i class="fas fa-exclamation-triangle"></i>
                <span>${message}</span>
            </div>
        `;
    }
    
    // Exponer funciones globalmente para uso en otros scripts
    window.acudienteMenu = {
        getSelectedChildId: () => selectedChildId,
        getChildrenData: () => childrenData,
        selectChild: selectChild,
        loadChildren: loadChildren
    };
});
</script>

</body>
</html>
