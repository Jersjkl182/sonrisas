{% extends 'base_admin.html' %}
{% block title %}Bitácora de Auditoría - Teaching Notes{% endblock %}

{% block extra_css %}
<style>
/* ===== ESTILOS PARA AUDITORÍA - INLINE ===== */
body .audit-header,
html .audit-header {
    background: linear-gradient(135deg, #667eea, #764ba2) !important;
    color: white !important;
    padding: 30px !important;
    border-radius: 20px !important;
    margin-bottom: 30px !important;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1) !important;
}

body .header-content,
html .header-content {
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    flex-wrap: wrap !important;
    gap: 20px !important;
}

body .header-left,
html .header-left {
    display: flex !important;
    align-items: center !important;
    gap: 20px !important;
}

body .header-icon,
html .header-icon {
    width: 60px !important;
    height: 60px !important;
    background: rgba(255, 255, 255, 0.2) !important;
    border-radius: 50% !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    font-size: 24px !important;
}

body .header-text h1,
html .header-text h1 {
    font-size: 28px !important;
    font-weight: 700 !important;
    margin: 0 0 8px 0 !important;
    font-family: 'Montserrat Alternates', sans-serif !important;
}

body .header-text p,
html .header-text p {
    margin: 0 !important;
    opacity: 0.9 !important;
    font-size: 14px !important;
}

body .header-actions,
html .header-actions {
    display: flex !important;
    gap: 15px !important;
    flex-wrap: wrap !important;
}

body .btn-export,
html .btn-export {
    background: rgba(255, 255, 255, 0.2) !important;
    color: white !important;
    padding: 12px 20px !important;
    border-radius: 25px !important;
    text-decoration: none !important;
    font-weight: 600 !important;
    display: flex !important;
    align-items: center !important;
    gap: 8px !important;
    transition: all 0.3s ease !important;
    border: 1px solid rgba(255, 255, 255, 0.3) !important;
}

body .btn-export:hover,
html .btn-export:hover {
    background: rgba(255, 255, 255, 0.3) !important;
    transform: translateY(-2px) !important;
    text-decoration: none !important;
    color: white !important;
}

/* Filtros */
body .filters-section,
html .filters-section {
    background: rgba(255, 255, 255, 0.95) !important;
    backdrop-filter: blur(15px) !important;
    border-radius: 20px !important;
    padding: 25px !important;
    margin-bottom: 30px !important;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1) !important;
}

body .filter-grid,
html .filter-grid {
    display: grid !important;
    grid-template-columns: auto 1fr 1fr auto !important;
    gap: 20px !important;
    margin-bottom: 20px !important;
    align-items: end !important;
}

body .date-filters,
html .date-filters {
    display: flex !important;
    gap: 15px !important;
}

body .filter-item,
html .filter-item {
    display: flex !important;
    flex-direction: column !important;
    gap: 8px !important;
}

body .filter-actions,
html .filter-actions {
    display: flex !important;
    gap: 10px !important;
    align-items: end !important;
}

body .filter-item label,
html .filter-item label {
    display: block !important;
    margin-bottom: 8px !important;
    font-weight: 600 !important;
    color: #2c3e50 !important;
    font-size: 14px !important;
}

body .filter-item input,
body .filter-item select,
html .filter-item input,
html .filter-item select {
    width: 100% !important;
    padding: 12px !important;
    border: 2px solid #e1e8ed !important;
    border-radius: 15px !important;
    font-size: 14px !important;
    transition: all 0.3s ease !important;
    background: rgba(255, 255, 255, 0.9) !important;
}

body .filter-item input:focus,
body .filter-item select:focus,
html .filter-item input:focus,
html .filter-item select:focus {
    outline: none !important;
    border-color: #667eea !important;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1) !important;
    background: rgba(255, 255, 255, 1) !important;
}

/* Contenedor de botones */
body .filter-buttons,
html .filter-buttons {
    display: flex !important;
    gap: 10px !important;
    align-items: center !important;
    justify-content: flex-start !important;
}

body .btn-filter,
html .btn-filter {
    background: linear-gradient(135deg, #667eea, #764ba2) !important;
    color: white !important;
    padding: 12px 20px !important;
    border: none !important;
    border-radius: 25px !important;
    font-weight: 600 !important;
    cursor: pointer !important;
    transition: all 0.3s ease !important;
    font-size: 14px !important;
    display: flex !important;
    align-items: center !important;
    gap: 8px !important;
    white-space: nowrap !important;
}

body .btn-filter:hover,
html .btn-filter:hover {
    background: linear-gradient(135deg, #764ba2, #667eea) !important;
    transform: translateY(-2px) !important;
    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3) !important;
}

body .btn-clear,
html .btn-clear {
    background: rgba(255, 255, 255, 0.2) !important;
    color: #495057 !important;
    padding: 12px 20px !important;
    border: 2px solid rgba(255, 255, 255, 0.3) !important;
    border-radius: 25px !important;
    font-weight: 600 !important;
    cursor: pointer !important;
    transition: all 0.3s ease !important;
    font-size: 14px !important;
    display: flex !important;
    align-items: center !important;
    gap: 8px !important;
    white-space: nowrap !important;
}

body .btn-clear:hover,
html .btn-clear:hover {
    background: rgba(255, 255, 255, 0.3) !important;
    color: #2c3e50 !important;
    transform: translateY(-2px) !important;
}

/* Contenedor de tabla con glassmorphism */
body .audit-table-container,
html .audit-table-container {
    background: rgba(255, 255, 255, 0.15) !important;
    backdrop-filter: blur(20px) !important;
    -webkit-backdrop-filter: blur(20px) !important;
    border: 1px solid rgba(255, 255, 255, 0.3) !important;
    border-radius: 25px !important;
    overflow: hidden !important;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1) !important;
    margin-bottom: 30px !important;
}

body .table-header,
html .table-header {
    background: rgba(255, 255, 255, 0.2) !important;
    backdrop-filter: blur(10px) !important;
    -webkit-backdrop-filter: blur(10px) !important;
    padding: 20px 25px !important;
    border-bottom: 1px solid rgba(255, 255, 255, 0.3) !important;
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
}

body .table-header h3,
html .table-header h3 {
    color: #2c3e50 !important;
    font-size: 18px !important;
    font-weight: 700 !important;
    margin: 0 !important;
    display: flex !important;
    align-items: center !important;
    gap: 10px !important;
}

body .record-count,
html .record-count {
    color: #495057 !important;
    font-size: 14px !important;
    font-weight: 600 !important;
    opacity: 0.8 !important;
}

body .table-wrapper,
html .table-wrapper {
    background: transparent !important;
    border-radius: 0 0 25px 25px !important;
    overflow: hidden !important;
}

/* Tabla de auditoría */
body .audit-table,
html .audit-table {
    background: transparent !important;
    width: 100% !important;
    border-collapse: collapse !important;
    margin: 0 !important;
}

body .audit-table table,
html .audit-table table {
    width: 100% !important;
    border-collapse: collapse !important;
}

body .audit-table th,
html .audit-table th {
    background: rgba(255, 255, 255, 0.2) !important;
    backdrop-filter: blur(10px) !important;
    -webkit-backdrop-filter: blur(10px) !important;
    padding: 15px !important;
    text-align: left !important;
    font-weight: 600 !important;
    color: #2c3e50 !important;
    border-bottom: 1px solid rgba(255, 255, 255, 0.3) !important;
}

body .audit-table td,
html .audit-table td {
    padding: 15px !important;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2) !important;
    color: #2c3e50 !important;
    background: transparent !important;
}

body .audit-table tr:hover,
html .audit-table tr:hover {
    background: rgba(255, 255, 255, 0.1) !important;
    backdrop-filter: blur(5px) !important;
    -webkit-backdrop-filter: blur(5px) !important;
}

body .audit-table tr:hover td,
html .audit-table tr:hover td {
    color: #2c3e50 !important;
}

/* Tarjetas de estadísticas horizontales */
body .stats-container,
html .stats-container {
    display: grid !important;
    grid-template-columns: repeat(4, 1fr) !important;
    gap: 20px !important;
    margin-bottom: 30px !important;
}

body .stat-card,
html .stat-card {
    background: rgba(255, 255, 255, 0.15) !important;
    backdrop-filter: blur(20px) !important;
    -webkit-backdrop-filter: blur(20px) !important;
    border-radius: 20px !important;
    border: 1px solid rgba(255, 255, 255, 0.3) !important;
    padding: 25px !important;
    display: flex !important;
    align-items: center !important;
    gap: 20px !important;
    transition: all 0.3s ease !important;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1) !important;
}

body .stat-card:hover,
html .stat-card:hover {
    background: rgba(255, 255, 255, 0.2) !important;
    transform: translateY(-5px) !important;
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15) !important;
}

body .stat-icon,
html .stat-icon {
    width: 60px !important;
    height: 60px !important;
    background: linear-gradient(135deg, #667eea, #764ba2) !important;
    border-radius: 50% !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    color: white !important;
    font-size: 24px !important;
    flex-shrink: 0 !important;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3) !important;
}

body .stat-content,
html .stat-content {
    flex: 1 !important;
}

body .stat-number,
html .stat-number {
    font-size: 32px !important;
    font-weight: 700 !important;
    color: #2c3e50 !important;
    margin: 0 0 5px 0 !important;
    font-family: 'Montserrat Alternates', sans-serif !important;
    line-height: 1 !important;
}

body .stat-label,
html .stat-label {
    font-size: 14px !important;
    color: #495057 !important;
    font-weight: 600 !important;
    margin: 0 !important;
    opacity: 0.8 !important;
}

/* Iconos específicos por tipo */
body .stat-card:nth-child(1) .stat-icon,
html .stat-card:nth-child(1) .stat-icon {
    background: linear-gradient(135deg, #667eea, #764ba2) !important;
}

body .stat-card:nth-child(2) .stat-icon,
html .stat-card:nth-child(2) .stat-icon {
    background: linear-gradient(135deg, #42a5f5, #1e88e5) !important;
}

body .stat-card:nth-child(3) .stat-icon,
html .stat-card:nth-child(3) .stat-icon {
    background: linear-gradient(135deg, #26c6da, #00acc1) !important;
}

body .stat-card:nth-child(4) .stat-icon,
html .stat-card:nth-child(4) .stat-icon {
    background: linear-gradient(135deg, #ab47bc, #8e24aa) !important;
}

/* Enlace de exportar */
body .export-link,
html .export-link {
    text-decoration: none !important;
    color: inherit !important;
    display: block !important;
    width: 100% !important;
}

body .export-link:hover,
html .export-link:hover {
    text-decoration: none !important;
    color: inherit !important;
}

body .export-link .stat-number,
html .export-link .stat-number {
    color: #2c3e50 !important;
    text-decoration: underline !important;
    cursor: pointer !important;
}

body .export-link:hover .stat-number,
html .export-link:hover .stat-number {
    color: #ab47bc !important;
}

/* Responsive */
@media (max-width: 1200px) {
    body .stats-container,
    html .stats-container {
        grid-template-columns: repeat(2, 1fr) !important;
    }
    
    body .filter-grid,
    html .filter-grid {
        grid-template-columns: 1fr 1fr !important;
        gap: 15px !important;
    }
    
    body .date-filters,
    html .date-filters {
        grid-column: 1 / -1 !important;
    }
    
    body .filter-actions,
    html .filter-actions {
        grid-column: 1 / -1 !important;
        justify-content: center !important;
    }
}

@media (max-width: 768px) {
    body .header-content,
    html .header-content {
        flex-direction: column !important;
        text-align: center !important;
    }
    
    body .filter-grid,
    html .filter-grid {
        grid-template-columns: 1fr !important;
        gap: 15px !important;
    }
    
    body .date-filters,
    html .date-filters {
        flex-direction: column !important;
    }
    
    body .filter-actions,
    html .filter-actions {
        justify-content: center !important;
        flex-wrap: wrap !important;
    }
    
    body .audit-table,
    html .audit-table {
        overflow-x: auto !important;
    }
    
    body .stats-container,
    html .stats-container {
        grid-template-columns: 1fr !important;
    }
    
    body .stat-card,
    html .stat-card {
        flex-direction: column !important;
        text-align: center !important;
        gap: 15px !important;
    }
}
</style>
{% endblock %}

{% block content %}

<!-- Header moderno -->
<div class="audit-header">
    <div class="header-content">
        <div class="header-left">
            <div class="header-icon">
                <i class="fas fa-clipboard-list"></i>
            </div>
            <div class="header-text">
                <h1>Bitácora de Auditoría</h1>
                <p>Registro completo de acciones administrativas del sistema</p>
            </div>
        </div>
        <div class="header-actions">
            <button class="btn-refresh" onclick="location.reload()">
                <i class="fas fa-sync-alt"></i>
                Actualizar
            </button>
        </div>
    </div>
</div>

<!-- Estadísticas rápidas -->
<div class="stats-container">
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-list-alt"></i>
        </div>
        <div class="stat-content">
            <div class="stat-number">{{ logs|length }}</div>
            <div class="stat-label">Total Registros</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-calendar-day"></i>
        </div>
        <div class="stat-content">
            <div class="stat-number">{{ today_logs_count if today_logs_count is defined else 0 }}</div>
            <div class="stat-label">Acciones Hoy</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-users-cog"></i>
        </div>
        <div class="stat-content">
            <div class="stat-number">{{ admins|length }}</div>
            <div class="stat-label">Administradores</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-download"></i>
        </div>
        <div class="stat-content">
            <a href="{{ url_for('admin_bp.export_auditoria', start_date=filtros.start_date, end_date=filtros.end_date, accion=filtros.accion, admin_id=filtros.admin_id, q=filtros.q) }}" class="export-link">
                <div class="stat-number">CSV</div>
                <div class="stat-label">Exportar</div>
            </a>
        </div>
    </div>
</div>

<!-- Filtros modernos -->
<div class="filters-container">
    <div class="filters-header">
        <h3><i class="fas fa-filter"></i> Filtros de Búsqueda</h3>
    </div>
    <form class="modern-filters" method="get">
        <div class="filter-grid">
            <!-- Fechas horizontales -->
            <div class="date-filters">
                <div class="filter-item">
                    <label for="start_date"><i class="fas fa-calendar-alt"></i> Fecha Inicio</label>
                    <input type="date" id="start_date" name="start_date" value="{{ filtros.start_date }}">
                </div>
                <div class="filter-item">
                    <label for="end_date"><i class="fas fa-calendar-alt"></i> Fecha Fin</label>
                    <input type="date" id="end_date" name="end_date" value="{{ filtros.end_date }}">
                </div>
            </div>
            
            <!-- Otros filtros -->
            <div class="filter-item">
                <label for="accion"><i class="fas fa-cogs"></i> Tipo de Acción</label>
                <select id="accion" name="accion">
                    <option value="">Todas las acciones</option>
                    {% for a in acciones %}
                    <option value="{{ a }}" {% if filtros.accion == a %}selected{% endif %}>{{ a.capitalize() }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="filter-item">
                <label for="admin_id"><i class="fas fa-user-shield"></i> Administrador</label>
                <select id="admin_id" name="admin_id">
                    <option value="">Todos los administradores</option>
                    {% for adm in admins %}
                    <option value="{{ adm.id }}" {% if filtros.admin_id == adm.id %}selected{% endif %}>{{ adm.correo }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="filter-item">
                <label for="q"><i class="fas fa-search"></i> Búsqueda de Texto</label>
                <input type="text" id="q" name="q" placeholder="Buscar en detalles..." value="{{ filtros.q }}">
            </div>
            <div class="filter-actions">
                <button type="submit" class="btn-filter">
                    <i class="fas fa-search"></i>
                    Filtrar
                </button>
                <a href="{{ url_for('admin_bp.ver_auditoria') }}" class="btn-clear">
                    <i class="fas fa-times"></i>
                    Limpiar
                </a>
            </div>
        </div>
    </form>
</div>
<!-- Tabla moderna -->
<div class="audit-table-container">
    <div class="table-header">
        <h3><i class="fas fa-table"></i> Registro de Auditoría</h3>
        <div class="table-info">
            <span class="record-count">{{ logs|length }} registros encontrados</span>
        </div>
    </div>
    
    <div class="table-wrapper">
        <table class="audit-table">
            <thead>
                <tr>
                    <th><i class="fas fa-calendar-alt"></i> Fecha y Hora</th>
                    <th><i class="fas fa-cog"></i> Acción</th>
                    <th><i class="fas fa-user-shield"></i> Administrador</th>
                    <th><i class="fas fa-user"></i> Usuario Afectado</th>
                    <th><i class="fas fa-info-circle"></i> Detalles</th>
                </tr>
            </thead>
            <tbody>
                {% for log in logs %}
                <tr class="audit-row">
                    <td class="date-cell">
                        <div class="date-container">
                            <div class="date-main">{{ log.fecha.strftime('%d/%m/%Y') if log.fecha else '-' }}</div>
                            <div class="time-sub">{{ log.fecha.strftime('%H:%M:%S') if log.fecha else '' }}</div>
                        </div>
                    </td>
                    <td class="action-cell">
                        <span class="action-badge action-{{ log.accion }}">
                            <i class="fas fa-{{ 'plus' if log.accion == 'crear' else 'edit' if log.accion == 'editar' else 'trash' if log.accion == 'eliminar' else 'cog' }}"></i>
                            {{ log.accion.capitalize() }}
                        </span>
                    </td>
                    <td class="admin-cell">
                        <div class="user-info">
                            <i class="fas fa-user-shield"></i>
                            <span>{{ log.admin_correo or 'Sistema' }}</span>
                        </div>
                    </td>
                    <td class="user-cell">
                        <div class="user-info">
                            <i class="fas fa-user"></i>
                            <span>{{ log.user_correo or '-' }}</span>
                        </div>
                    </td>
                    <td class="details-cell">
                        <div class="details-content">
                            {{ log.detalles or 'Sin detalles adicionales' }}
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr class="empty-row">
                    <td colspan="5">
                        <div class="empty-state">
                            <i class="fas fa-search"></i>
                            <h4>No se encontraron registros</h4>
                            <p>No hay registros de auditoría que coincidan con los filtros aplicados.</p>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Paginación moderna -->
{% if paginacion %}
<div class="pagination-container">
    <div class="pagination-info">
        <span>Página {{ paginacion.page }} de {{ paginacion.pages if paginacion.pages else 1 }}</span>
    </div>
    <div class="pagination-controls">
        {% if paginacion.has_prev %}
        <a class="pagination-btn prev" href="{{ url_for('admin_bp.ver_auditoria', start_date=filtros.start_date, end_date=filtros.end_date, accion=filtros.accion, admin_id=filtros.admin_id, page=paginacion.page-1) }}">
            <i class="fas fa-chevron-left"></i>
            Anterior
        </a>
        {% endif %}
        
        {% if paginacion.has_next %}
        <a class="pagination-btn next" href="{{ url_for('admin_bp.ver_auditoria', start_date=filtros.start_date, end_date=filtros.end_date, accion=filtros.accion, admin_id=filtros.admin_id, page=paginacion.page+1) }}">
            Siguiente
            <i class="fas fa-chevron-right"></i>
        </a>
        {% endif %}
    </div>
</div>
{% endif %}

{% endblock %}
